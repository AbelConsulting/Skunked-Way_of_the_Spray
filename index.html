<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <title>Skunk Fu - 2D Beat 'em Up</title>
    <link rel="stylesheet" href="styles.css">

    <style>
        /* INLINE STYLES FOR MOBILE OPTIMIZATION */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            overflow: hidden; /* Prevent scroll */
            user-select: none; /* Prevent text selection */
            -webkit-user-select: none;
        }

        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            /* CRITICAL: Stops browser handling gestures */
            touch-action: none; 
        }

        canvas {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* --- TOUCH CONTROLS UI --- */
        #touch-controls {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; /* Let touches pass through empty areas */
            z-index: 100;
            display: none; /* Hidden by default, shown via JS if mobile */
        }

        .control-group {
            position: absolute;
            bottom: 20px;
            pointer-events: auto;
        }

        #d-pad { left: 20px; }
        #actions { right: 20px; }

        .touch-btn {
            width: 70px;
            height: 70px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            color: white;
            font-size: 24px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            margin: 5px;
            user-select: none;
            outline: none;
            /* Disable browser touch actions */
            touch-action: none; 
            -webkit-tap-highlight-color: transparent;
        }

        .touch-btn:active {
            background: rgba(255, 255, 255, 0.5);
            transform: scale(0.95);
        }

        /* --- OVERLAYS --- */
        #mobile-start-overlay, #rotate-message {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 200;
            color: white;
            font-family: sans-serif;
        }

        #mobile-start-btn {
            padding: 15px 40px;
            font-size: 1.5rem;
            background: #ff4d4d;
            border: none;
            color: white;
            border-radius: 8px;
            text-transform: uppercase;
            font-weight: bold;
        }

        /* --- ORIENTATION CHECK --- */
        #rotate-message { display: none; }
        
        @media screen and (orientation: portrait) {
            #rotate-message { display: flex; }
            #game-container { display: none; }
        }
    </style>
</head>
<body>

    <div id="rotate-message">
        <h1>Please Rotate Your Device</h1>
        <p>Landscape mode required</p>
    </div>

    <div id="game-container">
        <canvas id="game-canvas" width="1280" height="720"></canvas>
        
        <div id="loading-screen">
            <div class="loading-content">
                <h1>Skunk Fu</h1>
                <div class="loading-bar">
                    <div id="loading-progress" class="loading-progress"></div>
                </div>
                <p id="loading-text">Loading assets...</p>
            </div>
        </div>

        <div id="touch-controls">
            <div id="d-pad" class="control-group">
                <button class="touch-btn" id="btn-left">&#8592;</button>
                <button class="touch-btn" id="btn-right">&#8594;</button>
            </div>
            
            <div id="actions" class="control-group">
                <button class="touch-btn" id="btn-attack" style="background: rgba(255, 50, 50, 0.3);">&#x2694;</button>
                <button class="touch-btn" id="btn-jump">&#8593;</button>
            </div>
        </div>

        <div id="mobile-start-overlay" style="display:none;">
            <button id="mobile-start-btn">Tap to Start</button>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/spriteLoader.js"></script>
    <script src="js/audioManager.js"></script>
    <script src="js/visualEffects.js"></script>
    <script src="js/level.js"></script>
    <script src="js/player.js"></script>
    <script src="js/enemy.js"></script>
    <script src="js/enemyManager.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/game.js"></script>
    <script src="js/main.js"></script>

<script>
// --- UTILITIES ---
function isMobile() {
    return /Android|iPhone|iPad|iPod|Opera Mini|IEMobile|WPDesktop/i.test(navigator.userAgent);
}

function triggerKeyEvent(key, type) {
    const event = new KeyboardEvent(type, { key: key, code: key });
    window.dispatchEvent(event);
}

// --- CONTROLS LOGIC ---
if (isMobile()) {
    document.getElementById('touch-controls').style.display = 'block';

    const setupBtn = (id, key) => {
        const btn = document.getElementById(id);
        if(!btn) return;

        // Prevent context menu on long press
        btn.oncontextmenu = (e) => { e.preventDefault(); e.stopPropagation(); return false; };

        // Handle Touch Start
        btn.addEventListener('touchstart', (e) => {
            e.preventDefault(); // Critical: stops mouse emulation and scrolling
            triggerKeyEvent(key, 'keydown');
            // Special case for Jump to also trigger 'ArrowUp' if your game logic needs it
            if(key === ' ') triggerKeyEvent('ArrowUp', 'keydown'); 
        }, { passive: false });

        // Handle Touch End
        btn.addEventListener('touchend', (e) => {
            e.preventDefault();
            triggerKeyEvent(key, 'keyup');
            if(key === ' ') triggerKeyEvent('ArrowUp', 'keyup');
        }, { passive: false });
    };

    setupBtn('btn-left', 'ArrowLeft');
    setupBtn('btn-right', 'ArrowRight');
    setupBtn('btn-jump', ' '); // Spacebar
    setupBtn('btn-attack', 'z'); // 'z' key
}

// --- MOBILE START & FULLSCREEN ---
const mobileStartOverlay = document.getElementById('mobile-start-overlay');
const mobileStartBtn = document.getElementById('mobile-start-btn');

function showMobileStartOverlay() {
    if (mobileStartOverlay) mobileStartOverlay.style.display = 'flex';
}
function hideMobileStartOverlay() {
    if (mobileStartOverlay) mobileStartOverlay.style.display = 'none';
}

function requestFullscreen() {
    const docEl = document.documentElement;
    const requestMethod = docEl.requestFullscreen || docEl.webkitRequestFullscreen || docEl.msRequestFullscreen;
    if (requestMethod) {
        requestMethod.call(docEl).catch(err => {
            // Silently fail if user denies or browser blocks
            console.log("Fullscreen request denied:", err);
        });
    }
}

if (isMobile() && mobileStartBtn) {
    showMobileStartOverlay();

    mobileStartBtn.addEventListener('touchend', function(e) {
        e.preventDefault();
        
        // 1. Enter Fullscreen
        requestFullscreen();

        // 2. Start Game Logic
        triggerKeyEvent('Enter', 'keydown');
        setTimeout(() => triggerKeyEvent('Enter', 'keyup'), 100); // Small delay ensures game registers input
        
        hideMobileStartOverlay();
    });

    // Re-show overlay if game goes back to Menu
    window.addEventListener('gameStateChange', function(e) {
        if (e.detail && (e.detail.state === 'MENU' || e.detail.state === 'GAME_OVER')) {
            showMobileStartOverlay();
        } else {
            hideMobileStartOverlay();
        }
    });
}
</script>
</body>
</html>