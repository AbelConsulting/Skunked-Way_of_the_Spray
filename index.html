<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <title>Skunk Fu - 2D Beat 'em Up</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üêæ</text></svg>">
        <!-- Content Security Policy: configured via HTTP header for stronger enforcement. -->
        <!-- Server should set a header similar to:
            Content-Security-Policy: script-src 'self' 'nonce-<random>' https://static.cloudflareinsights.com; object-src 'none'; base-uri 'self';
            The server should also inject the matching nonce into the inline <script nonce="%CSP_NONCE%"> tags below.
        -->
    <link rel="stylesheet" href="styles.css">

    <style>
        /* INLINE STYLES FOR MOBILE OPTIMIZATION */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            overflow: hidden; /* Prevent scroll */
            user-select: none; /* Prevent text selection */
            -webkit-user-select: none;
        }

        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            /* CRITICAL: Stops browser handling gestures */
            touch-action: none; 
        }

        canvas {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* --- TOUCH CONTROLS UI --- */
        #touch-controls {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; /* Let touches pass through empty areas */
            z-index: 100;
            display: none; /* Hidden by default, shown via JS if mobile */
        }

        .control-group {
            position: absolute;
            bottom: 20px;
            pointer-events: auto;
        }

        #d-pad { left: 20px; }
        #actions { right: 20px; }
        #game-over-controls { bottom: 100px; left: 50%; transform: translateX(-50%); }

        .touch-btn {
            width: 70px;
            height: 70px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            color: white;
            font-size: 24px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            margin: 5px;
            user-select: none;
            outline: none;
            /* Disable browser touch actions */
            touch-action: none; 
            -webkit-tap-highlight-color: transparent;
        }

        .touch-btn:active {
            background: rgba(255, 255, 255, 0.5);
            transform: scale(0.95);
        }

        /* --- OVERLAYS --- */
        #mobile-start-overlay, #rotate-message {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 200;
            color: white;
            font-family: sans-serif;
        }

        #mobile-start-btn {
            padding: 15px 40px;
            font-size: 1.5rem;
            background: #ff4d4d;
            border: none;
            color: white;
            border-radius: 8px;
            text-transform: uppercase;
            font-weight: bold;
        }

        #mobile-restart-btn {
            padding: 15px 40px;
            font-size: 1.5rem;
            background: #4dff4d;
            border: none;
            color: white;
            border-radius: 8px;
            text-transform: uppercase;
            font-weight: bold;
        }

        /* --- ORIENTATION CHECK --- */
        #rotate-message { display: none; }
        
        @media screen and (orientation: portrait) {
            #rotate-message { display: flex; }
            #game-container { display: none; }
        }
    </style>
</head>
<body>

    <div id="rotate-message">
        <h1>Please Rotate Your Device</h1>
        <p>Landscape mode required</p>
    </div>

    <div id="game-container">
        <canvas id="game-canvas" width="1280" height="720"></canvas>
        
        <div id="loading-screen">
            <div class="loading-content">
                <h1>Skunk Fu</h1>
                <div class="loading-bar">
                    <div id="loading-progress" class="loading-progress"></div>
                </div>
                <p id="loading-text">Loading assets...</p>
            </div>
        </div>

        <!-- Touch controls moved out of #game-container to avoid transform/layout issues -->

        <div id="mobile-start-overlay" style="display:none;">
            <button id="mobile-start-btn">Tap to Start</button>
        </div>

        <!-- Error overlay (shown when runtime errors occur) -->
        <div id="error-overlay" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.92); color:#fff; z-index:4000; padding:20px; overflow:auto;">
            <h2 style="margin-bottom:8px;">Runtime Error</h2>
            <pre id="error-content" style="white-space:pre-wrap; font-size:13px; line-height:1.4;"></pre>
            <div style="margin-top:12px;">
                <button id="error-close" style="padding:8px 12px; margin-right:8px;">Close</button>
                <button id="error-copy" style="padding:8px 12px;">Copy</button>
            </div>
        </div>

        <div id="mobile-restart-overlay" style="display:none;">
            <button id="mobile-restart-btn">Tap to Restart</button>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/spriteLoader.js"></script>
    <script src="js/audioManager.js"></script>
    <script src="js/visualEffects.js"></script>
    <script src="js/level.js"></script>
    <script src="js/player.js"></script>
    <script src="js/enemy.js"></script>
    <script src="js/enemyManager.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/game.js?v=6"></script>
    <script src="js/main.js"></script>

<script nonce="%CSP_NONCE%">
// --- UTILITIES ---
function isMobile() {
    return /Android|iPhone|iPad|iPod|Opera Mini|IEMobile|WPDesktop/i.test(navigator.userAgent);
}

function triggerKeyEvent(key, type) {
    const event = new KeyboardEvent(type, { key: key, code: key });
    window.dispatchEvent(event);
}

// --- CONTROLS LOGIC ---
function initTouchControls() {
    if (!isMobile()) return;

    const setupBtn = (id, key) => {
        const btn = document.getElementById(id);
        if(!btn) return;

        btn.oncontextmenu = (e) => { e.preventDefault(); e.stopPropagation(); return false; };

        const downHandler = (e) => {
            try { e && e.preventDefault(); } catch (_) {}
            triggerKeyEvent(key, 'keydown');
            if(key === ' ') triggerKeyEvent('ArrowUp', 'keydown');
        };
        const upHandler = (e) => {
            try { e && e.preventDefault(); } catch (_) {}
            triggerKeyEvent(key, 'keyup');
            if(key === ' ') triggerKeyEvent('ArrowUp', 'keyup');
        };

        btn.addEventListener('touchstart', downHandler, { passive: false });
        btn.addEventListener('touchend', upHandler, { passive: false });
        btn.addEventListener('pointerdown', downHandler);
        btn.addEventListener('pointerup', upHandler);
    };

    setupBtn('btn-left', 'ArrowLeft');
    setupBtn('btn-right', 'ArrowRight');
    setupBtn('btn-jump', ' ');
    setupBtn('btn-attack', 'x');
    setupBtn('btn-special', 'z');
    setupBtn('btn-pause', 'Escape');

    // Restart button handler
    const restartBtn = document.getElementById('btn-restart');
    if (restartBtn) {
        restartBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            triggerKeyEvent('Enter', 'keydown');
            setTimeout(() => triggerKeyEvent('Enter', 'keyup'), 100);
        }, { passive: false });
    }

    // Show/hide restart on game state
    window.addEventListener('gameStateChange', (e) => {
        if (restartBtn && e.detail.state === 'GAME_OVER') {
            restartBtn.style.display = 'block';
        } else if (restartBtn) {
            restartBtn.style.display = 'none';
        }
    });
}

// --- MOBILE START & FULLSCREEN ---
const mobileStartOverlay = document.getElementById('mobile-start-overlay');
const mobileStartBtn = document.getElementById('mobile-start-btn');
const mobileRestartOverlay = document.getElementById('mobile-restart-overlay');
const mobileRestartBtn = document.getElementById('mobile-restart-btn');

function showMobileStartOverlay() {
    if (mobileStartOverlay) mobileStartOverlay.style.display = 'flex';
}
function hideMobileStartOverlay() {
    if (mobileStartOverlay) mobileStartOverlay.style.display = 'none';
}

function showMobileRestartOverlay() {
    if (mobileRestartOverlay) mobileRestartOverlay.style.display = 'flex';
}
function hideMobileRestartOverlay() {
    if (mobileRestartOverlay) mobileRestartOverlay.style.display = 'none';
}

function requestFullscreen() {
    const docEl = document.documentElement;
    const requestMethod = docEl.requestFullscreen || docEl.webkitRequestFullscreen || docEl.msRequestFullscreen;
    if (requestMethod) {
        requestMethod.call(docEl).catch(err => {
            // Silently fail if user denies or browser blocks
            console.log("Fullscreen request denied:", err);
        });
    }
}

if (isMobile() && mobileStartBtn) {
    showMobileStartOverlay();

    mobileStartBtn.addEventListener('touchend', function(e) {
        e.preventDefault();
        
        if (!window.gameReady) return; // Wait for game to load
        
        // 1. Enter Fullscreen
        requestFullscreen();

        // 2. Start Game Logic
        triggerKeyEvent('Enter', 'keydown');
        setTimeout(() => triggerKeyEvent('Enter', 'keyup'), 100); // Small delay ensures game registers input
        
        hideMobileStartOverlay();
    });

    // Re-show overlay if game goes back to Menu
    window.addEventListener('gameStateChange', function(e) {
        if (e.detail && e.detail.state === 'MENU') {
            showMobileStartOverlay();
        } else {
            hideMobileStartOverlay();
        }
    });
}

// --- ORIENTATION & MOBILE UI HANDLING ---
function isLandscape() {
    return window.matchMedia && window.matchMedia('(orientation: landscape)').matches || window.innerWidth > window.innerHeight;
}

function updateMobileUI() {
    if (!isMobile()) return;

    if (!isLandscape()) {
        // Portrait: force rotate message, hide controls and start overlay
        const rotate = document.getElementById('rotate-message');
        if (rotate) rotate.style.display = 'flex';
        hideMobileStartOverlay();
        hideMobileRestartOverlay();
        const tc = document.getElementById('touch-controls');
        if (tc) tc.style.display = 'none';
    } else {
        // Landscape: allow overlays if appropriate
        const rotate = document.getElementById('rotate-message');
        if (rotate) rotate.style.display = 'none';
        // Only show start overlay when game is in MENU and ready
        if (window.gameReady && window.game && window.game.state === 'MENU') {
            showMobileStartOverlay();
        }
        const tc = document.getElementById('touch-controls');
        if (tc) tc.style.display = 'flex';
        // Ensure controls have listeners
        initTouchControls();
    }
}

window.addEventListener('orientationchange', updateMobileUI);
window.addEventListener('resize', updateMobileUI);
// run once on load
updateMobileUI();

if (isMobile() && mobileRestartBtn) {
    mobileRestartBtn.addEventListener('touchend', function(e) {
        e.preventDefault();
        
        if (!window.gameReady) return; // Wait for game to load
        
        // Restart Game Logic
        triggerKeyEvent('Enter', 'keydown');
        setTimeout(() => triggerKeyEvent('Enter', 'keyup'), 100);
        
        hideMobileRestartOverlay();
    });

    // Show restart overlay on game over
    window.addEventListener('gameStateChange', function(e) {
        if (e.detail && e.detail.state === 'GAME_OVER') {
            showMobileRestartOverlay();
        } else {
            hideMobileRestartOverlay();
        }
    });
}

// --- RUNTIME ERROR CAPTURE ---
(function () {
    const overlay = document.getElementById('error-overlay');
    const content = document.getElementById('error-content');
    const closeBtn = document.getElementById('error-close');
    const copyBtn = document.getElementById('error-copy');

    function showError(msg) {
        if (!overlay || !content) return;
        content.textContent = msg;
        overlay.style.display = 'block';
    }

    if (closeBtn) closeBtn.addEventListener('click', () => { overlay.style.display = 'none'; });
    if (copyBtn) copyBtn.addEventListener('click', () => { if (navigator.clipboard) navigator.clipboard.writeText(content.textContent || ''); });

    window.addEventListener('error', (e) => {
        const msg = `${e.message} at ${e.filename}:${e.lineno}:${e.colno}\n${e.error && e.error.stack ? e.error.stack : ''}`;
        console.error('Captured error:', msg);
        showError(msg);
    });

    window.addEventListener('unhandledrejection', (ev) => {
        const reason = ev.reason ? (ev.reason.stack || ev.reason) : 'Unknown';
        const msg = `Unhandled Rejection: ${reason}`;
        console.error(msg);
        showError(msg);
    });
})();

/* Re-insert touch controls as a fixed overlay so transforms on #game-container don't affect layout */
(function() {
    const html = `
    <div id="touch-controls" style="position:fixed; bottom:20px; left:0; right:0; transform:none; display:flex; justify-content:space-between; align-items:flex-end; pointer-events:none; z-index:2000; padding:0 20px;">
        <div id="d-pad" class="control-group" style="pointer-events:auto; display:flex; gap:8px;">
            <button class="touch-btn" id="btn-left">&#8592;</button>
            <button class="touch-btn" id="btn-right">&#8594;</button>
        </div>
        <div id="game-over-controls" class="control-group" style="pointer-events:auto; display:flex; gap:8px;">
            <button class="touch-btn" id="btn-restart" style="display:none;">Restart</button>
        </div>
        <div id="actions" class="control-group" style="pointer-events:auto; display:flex; gap:8px;">
            <button class="touch-btn" id="btn-attack" style="background: rgba(255, 50, 50, 0.3);">Attack</button>
            <button class="touch-btn" id="btn-special" style="background: rgba(255, 100, 255, 0.3);">Special</button>
            <button class="touch-btn" id="btn-jump">&#8593;</button>
            <button class="touch-btn" id="btn-pause">Pause</button>
        </div>
    </div>
    `;
    document.body.insertAdjacentHTML('beforeend', html);
})();
</script>
</body>
</html>