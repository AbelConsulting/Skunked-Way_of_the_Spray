name: CI & Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Run Playwright tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Start static server
        run: |
          nohup python3 -m http.server 8000 &
          # Wait up to 5s for the server to respond on port 8000
          for i in 1 2 3 4 5; do
            if curl -sSf http://localhost:8000/ >/dev/null; then
              echo "Server is up"; break
            fi
            sleep 1
          done

      - name: Run enemy missing-level telemetry test
        run: node tools/run_enemy_missing_level_sim.js

      - name: Upload telemetry test results
        uses: actions/upload-artifact@v4
        with:
          name: enemy-telemetry-results
          path: tools/run_enemy_missing_level_sim.json

  deploy:
    name: Deploy to Cloudflare Pages
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Prepare dist for publish
        run: |
          # ensure dist exists and contains static files
          ls -la dist || true
          echo "Dist contents:" && ls -la dist || true

      - name: Publish to Cloudflare Pages (using npm script)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          # If you're hosting on GitHub Pages, leave the Cloudflare secrets unset.
          # In that case, this step will print a notice and exit successfully.
          if [ -z "$CLOUDFLARE_API_TOKEN" ]; then
            echo "::notice::Cloudflare Pages deploy skipped (CLOUDFLARE_API_TOKEN not set)." >&2
            exit 0
          fi
          if [ -z "$CLOUDFLARE_ACCOUNT_ID" ]; then
            echo "::notice::Cloudflare Pages deploy skipped (CLOUDFLARE_ACCOUNT_ID not set)." >&2
            exit 0
          fi

          # Normalize (common issue: accidental whitespace/newlines in GitHub secrets)
          CLOUDFLARE_API_TOKEN_RAW="$CLOUDFLARE_API_TOKEN"
          CLOUDFLARE_ACCOUNT_ID_RAW="$CLOUDFLARE_ACCOUNT_ID"
          CLOUDFLARE_API_TOKEN=$(printf '%s' "$CLOUDFLARE_API_TOKEN_RAW" | tr -d '[:space:]')
          CLOUDFLARE_ACCOUNT_ID=$(printf '%s' "$CLOUDFLARE_ACCOUNT_ID_RAW" | tr -d '[:space:]')

          if [ "$CLOUDFLARE_ACCOUNT_ID" != "$CLOUDFLARE_ACCOUNT_ID_RAW" ]; then
            echo "Note: CLOUDFLARE_ACCOUNT_ID contained whitespace; trimmed it before validation." >&2
          fi

          # Basic sanity check: Cloudflare account IDs are 32 hex chars
          if ! printf '%s' "$CLOUDFLARE_ACCOUNT_ID" | grep -Eq '^[0-9a-fA-F]{32}$'; then
            LEN=$(printf '%s' "$CLOUDFLARE_ACCOUNT_ID" | wc -c | tr -d '[:space:]')
            PREFIX=$(printf '%s' "$CLOUDFLARE_ACCOUNT_ID" | cut -c1-4)
            SUFFIX=$(printf '%s' "$CLOUDFLARE_ACCOUNT_ID" | rev | cut -c1-4 | rev)
            echo "::warning::Cloudflare Pages deploy skipped: CLOUDFLARE_ACCOUNT_ID does not look like a valid Cloudflare Account ID." >&2
            echo "  - Expected: 32 hex characters (0-9, a-f)." >&2
            echo "  - Got length: ${LEN}." >&2
            if [ -n "$PREFIX$SUFFIX" ]; then
              echo "  - Value preview: ${PREFIX}…${SUFFIX} (masked)." >&2
            fi
            echo "Fix: In your GitHub repo: Settings → Secrets and variables → Actions → New repository secret" >&2
            echo "  - Name: CLOUDFLARE_ACCOUNT_ID" >&2
            echo "  - Value: your Cloudflare dashboard Account ID (shown in the dashboard sidebar), 32 hex chars." >&2
            exit 0
          fi

          export CLOUDFLARE_API_TOKEN
          export CLOUDFLARE_ACCOUNT_ID

          # Use npx to ensure a consistent wrangler version in CI
          npx --yes wrangler@4 --version

          # Confirm token/account context (safe; account id may be masked by GitHub logs)
          npx --yes wrangler@4 whoami || true

          # Guard: disallow accidental use of `wrangler deploy` (worker deploy) in CI
          echo "Checking for accidental `wrangler deploy` usage..."
          if grep -R "wrangler deploy" -n .; then
            echo "Note: 'wrangler deploy' may attempt to deploy a Worker by default. This workflow publishes to Pages using 'wrangler pages publish' via the npm script 'deploy:pages'.";
          fi

          # Determine Pages project name from wrangler.jsonc (source of truth)
          PROJECT_NAME=$(node -e "const fs=require('fs'); const t=fs.readFileSync('wrangler.jsonc','utf8'); const noComments=t.replace(/\/\/.*$/mg,'').replace(/\/\*[\s\S]*?\*\//g,''); const j=JSON.parse(noComments); process.stdout.write(String(j.name||''));")
          if [ -z "$PROJECT_NAME" ]; then
            echo "Error: Cloudflare Pages project name is not set. Set 'name' in wrangler.jsonc." >&2
            exit 1
          fi

          echo "Deploying to Cloudflare Pages project: $PROJECT_NAME"

          # Optional preflight: ensure the Pages project exists (create if missing)
          # If your token cannot create projects, this will fail with a clear error.
          if ! npx --yes wrangler@4 pages project list --account-id "$CLOUDFLARE_ACCOUNT_ID" | grep -Fq "$PROJECT_NAME"; then
            echo "Pages project '$PROJECT_NAME' not found; attempting to create it..."
            npx --yes wrangler@4 pages project create "$PROJECT_NAME" --production-branch main --account-id "$CLOUDFLARE_ACCOUNT_ID"
          fi

          # Deploy the already-built dist output (build step ran earlier in this workflow)
          npx --yes wrangler@4 pages deploy ./dist --project-name "$PROJECT_NAME" --account-id "$CLOUDFLARE_ACCOUNT_ID"


      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-dist
          path: dist
